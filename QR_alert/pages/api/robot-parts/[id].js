// API endpoint for robot parts data with AI agent analysis
import RobotDiagnosticAI from '../../../lib/aiAgent';
import { getFactoryManagerNotification } from '../../../lib/factoryManagerNotification';

export default function handler(req, res) {
  const { id } = req.query;
  
  if (!id) {
    return res.status(400).json({ error: 'Robot ID is required' });
  }

  // „É≠„Éú„ÉÉ„ÉàÈÉ®‰Ωç„ÅÆÂÆöÁæ©
  const robotParts = [
    { id: 'head', name: 'È†≠ÈÉ®' },
    { id: 'left_arm', name: 'Â∑¶ËÖï' },
    { id: 'right_arm', name: 'Âè≥ËÖï' },
    { id: 'torso', name: 'ËÉ¥‰Ωì' },
    { id: 'left_leg', name: 'Â∑¶ËÑö' },
    { id: 'right_leg', name: 'Âè≥ËÑö' },
    { id: 'base', name: '„Éô„Éº„Çπ' }
  ];

  // Docker„Ç≥„É≥„ÉÜ„Éä„ÅÆÁèæÂú®ÊôÇÂàª„ÇíÂèñÂæó
  const containerTime = new Date();
  const containerTimestamp = containerTime.toISOString();
  
  // AI„Ç®„Éº„Ç∏„Çß„É≥„Éà„Å®Â∑•Â†¥Ë≤¨‰ªªËÄÖÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ
  const aiAgent = new RobotDiagnosticAI();
  const factoryNotification = getFactoryManagerNotification();
  
  // „É≠„Éú„ÉÉ„ÉàID„Å´Âü∫„Å•„Åè„Ç∑„Éº„ÉâÂÄ§ÁîüÊàê
  const seed = Array.from(id).reduce((s, c) => s + c.charCodeAt(0), 0);
  const timeSeed = Math.floor(Date.now() / 3000); // 3Áßí„Åî„Å®„Å´Êõ¥Êñ∞Ôºà„Çà„ÇäÈ†ªÁπÅ„Å´Ôºâ
  const combinedSeed = (seed + timeSeed) % 1000;

  // Ê∏©Â∫¶„Çπ„Éë„Ç§„ÇØÂ±•Ê≠¥„Çí‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØDB„Çí‰ΩøÁî®Ôºâ
  if (!global.temperatureHistory) {
    global.temperatureHistory = {};
  }
  if (!global.temperatureHistory[id]) {
    global.temperatureHistory[id] = [];
  }

  // „Ç¢„É©„Éº„ÉàÂ±•Ê≠¥„Çí‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
  if (!global.alertHistory) {
    global.alertHistory = {};
  }
  if (!global.alertHistory[id]) {
    global.alertHistory[id] = [];
  }

  // Âç±Èô∫Áä∂Ê≥Å„ÅÆÈÄ£Á∂öÊ§úÁü•Â±•Ê≠¥„Çí‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
  if (!global.dangerHistory) {
    global.dangerHistory = {};
  }
  if (!global.dangerHistory[id]) {
    global.dangerHistory[id] = [];
  }

  // ÂêÑÈÉ®‰Ωç„ÅÆÁä∂ÊÖã„ÇíÁîüÊàê
  const parts = robotParts.map((part, index) => {
    const partSeed = (combinedSeed + index * 137) % 1000;
    
    // Ê∏©Â∫¶„Å®ÊåØÂãï„ÅÆÂü∫Êú¨ÂÄ§
    const tempBase = 35 + (partSeed % 20); // 35-55¬∞C
    const vibrationBase = 0.1 + ((partSeed % 30) / 200); // 0.1-0.25
    
    // ÊπøÂ∫¶„Éá„Éº„ÇøÁîüÊàêÔºà„Ç∑„Éß„Éº„Éà„É™„Çπ„ÇØË¶ÅÂõ†Ôºâ
    const humidityBase = 40 + (partSeed % 30); // 40-70%
    const humiditySpike = (partSeed % 15) === 0; // ÊπøÂ∫¶„Çπ„Éë„Ç§„ÇØ
    const humidity = humidityBase + (humiditySpike ? 25 : 0);
    
    // ÈÅãËª¢ÊôÇÈñì„Éá„Éº„ÇøÁîüÊàêÔºàÁñ≤Âä¥Ë¶ÅÂõ†Ôºâ- 1-48ÊôÇÈñì„ÅÆÁØÑÂõ≤„Å´‰øÆÊ≠£
    const operatingHours = 1 + (partSeed % 48); // 1-48ÊôÇÈñì„ÅÆÁØÑÂõ≤
    
    // ÊôÇ„ÄÖ„Çπ„Éë„Ç§„ÇØ„ÇíÁô∫ÁîüÔºà„Çà„ÇäÈ†ªÁπÅ„Å´Ôºâ
    const spike = (partSeed % 23) === 0; // „Çà„ÇäÈ†ªÁπÅ„Å´„Çπ„Éë„Ç§„ÇØ
    const temperature = tempBase + (spike ? 15 : 0);
    const vibration = vibrationBase + (spike ? 0.2 : 0);
    
    // Ê∏©Â∫¶„Çπ„Éë„Ç§„ÇØ„Çí„É≠„Ç∞„Å´Ë®òÈå≤
    if (spike && temperature > 50) {
      const spikeLog = {
        timestamp: containerTimestamp,
        partId: part.id,
        partName: part.name,
        temperature: temperature,
        spikeAmount: 15,
        containerTime: containerTime.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
        dockerTime: containerTime.toISOString()
      };
      
      global.temperatureHistory[id].push(spikeLog);
      
      // ÊúÄÊñ∞100‰ª∂„Åæ„Åß‰øùÊåÅ
      if (global.temperatureHistory[id].length > 100) {
        global.temperatureHistory[id] = global.temperatureHistory[id].slice(-100);
      }
    }
    
    // Âç±Èô∫Áä∂Ê≥Å„ÅÆÂà§ÂÆöÔºà3„Å§„ÅÆÂç±Èô∫Ë¶ÅÂõ†Ôºâ
    const isDangerous = temperature > 60 || vibration > 0.4 || humidity > 80;
    const dangerLevel = isDangerous ? 'critical' : (temperature > 50 || vibration > 0.3 || humidity > 70) ? 'warning' : 'normal';
    
    // Âç±Èô∫Áä∂Ê≥Å„ÅÆÂ±•Ê≠¥„Å´Ë®òÈå≤
    if (isDangerous) {
      const dangerLog = {
        timestamp: containerTimestamp,
        partId: part.id,
        partName: part.name,
        temperature,
        vibration,
        humidity,
        operatingHours,
        dangerLevel,
        containerTime: containerTime.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
        dockerTime: containerTime.toISOString()
      };
      
      global.dangerHistory[id].push(dangerLog);
      
      // ÊúÄÊñ∞50‰ª∂„Åæ„Åß‰øùÊåÅ
      if (global.dangerHistory[id].length > 50) {
        global.dangerHistory[id] = global.dangerHistory[id].slice(-50);
      }
    }
    
    // ÈÄ£Á∂öÂç±Èô∫Áä∂Ê≥Å„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÅéÂéª3Âõû„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÅßÂç±Èô∫Áä∂Ê≥Å„ÅåÁ∂ö„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
    const recentDangerCount = global.dangerHistory[id]
      .filter(log => {
        const logTime = new Date(log.timestamp);
        const now = new Date();
        const timeDiff = now.getTime() - logTime.getTime();
        return timeDiff < 15000; // ÈÅéÂéª15Áßí‰ª•ÂÜÖ
      })
      .length;
    
    const consecutiveDangerAlert = recentDangerCount >= 3;
    
    // Áä∂ÊÖãÂà§ÂÆöÔºàÂ§öË¶ÅÁ¥†ËÄÉÊÖÆ + ÈÄ£Á∂öÂç±Èô∫Áä∂Ê≥ÅÔºâ
    let status = 'normal';
    let issues = [];
    let alertGenerated = false;
    
    if (consecutiveDangerAlert) {
      status = 'emergency';
      issues.push('üö® EMERGENCY: ÈÄ£Á∂öÂç±Èô∫Áä∂Ê≥ÅÊ§úÁü• - Â∑•Â†¥Ë≤¨‰ªªËÄÖ„Å´„Çà„ÇãÂÅúÊ≠¢„ÅåÂøÖË¶Å');
      alertGenerated = true;
    } else if (temperature > 60 || vibration > 0.4 || humidity > 80 || operatingHours > 40) {
      status = 'critical';
      if (temperature > 60) issues.push('High temperature detected');
      if (vibration > 0.4) issues.push('Excessive vibration');
      if (humidity > 80) issues.push('High humidity - Short circuit risk');
      if (operatingHours > 40) issues.push('Material fatigue - High operating hours');
      alertGenerated = true;
    } else if (temperature > 50 || vibration > 0.3 || humidity > 70 || operatingHours > 30) {
      status = 'warning';
      if (temperature > 50) issues.push('Temperature rising');
      if (vibration > 0.3) issues.push('Increased vibration');
      if (humidity > 70) issues.push('Humidity rising - Condensation risk');
      if (operatingHours > 30) issues.push('Mechanical wear - Long operating hours');
      alertGenerated = true;
    }
    
    // ÈÉ®‰ΩçÂõ∫Êúâ„ÅÆÂïèÈ°å„ÇíËøΩÂä†
    if (part.id === 'left_arm' && (partSeed % 23) === 0) {
      status = 'warning';
      issues.push('Joint lubrication needed');
      alertGenerated = true;
    }
    
    if (part.id === 'torso' && (partSeed % 31) === 0) {
      status = 'critical';
      issues.push('Cooling system malfunction');
      alertGenerated = true;
    }
    
    if (part.id === 'base' && (partSeed % 19) === 0) {
      status = 'warning';
      issues.push('Base alignment check required');
      alertGenerated = true;
    }

    // „Ç¢„É©„Éº„Éà„ÇíÁîüÊàê
    if (alertGenerated) {
      const alert = {
        id: `${part.id}_${Date.now()}`,
        timestamp: containerTimestamp,
        partId: part.id,
        partName: part.name,
        status: status,
        temperature: temperature,
        vibration: vibration,
        issues: issues,
        containerTime: containerTime.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
        dockerTime: containerTime.toISOString(),
        message: `[UDP ALERT] ${part.name}: ${status.toUpperCase()} - ${issues.join(', ')}`
      };
      
      global.alertHistory[id].push(alert);
      
      // ÊúÄÊñ∞50‰ª∂„Åæ„Åß‰øùÊåÅ
      if (global.alertHistory[id].length > 50) {
        global.alertHistory[id] = global.alertHistory[id].slice(-50);
      }
    }

    // AI„Ç®„Éº„Ç∏„Çß„É≥„Éà„Å´„Çà„ÇãÂàÜÊûê
    const partData = {
      partId: part.id,
      partName: part.name,
      temperature,
      vibration,
      humidity,
      operatingHours,
      status
    };
    
    const aiAnalysis = aiAgent.generateComprehensiveAnalysis(partData);

    // Á∑äÊÄ•Áä∂Ê≥Å„ÅÆÂ†¥Âêà„ÅØÂ∑•Â†¥Ë≤¨‰ªªËÄÖ„Å´ÈÄöÁü•
    if (status === 'emergency') {
      const dangerDetails = [{
        partId: part.id,
        partName: part.name,
        temperature,
        vibration,
        humidity,
        operatingHours,
        dangerLevel: 'critical',
        containerTime: containerTime.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
        dockerTime: containerTime.toISOString()
      }];
      
      factoryNotification.sendEmergencyNotification(id, dangerDetails);
    }

    return {
      id: part.id,
      name: part.name,
      status,
      temperature,
      vibration,
      humidity,
      operatingHours,
      lastUpdate: containerTimestamp,
      issues,
      containerTime: containerTime.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
      dockerTime: containerTime.toISOString(),
      // AIÂàÜÊûêÁµêÊûú
      aiAnalysis: {
        overallSeverity: aiAnalysis.overallSeverity,
        temperatureAnalysis: aiAnalysis.temperatureAnalysis,
        vibrationAnalysis: aiAnalysis.vibrationAnalysis,
        humidityAnalysis: aiAnalysis.humidityAnalysis,
        fatigueAnalysis: aiAnalysis.fatigueAnalysis,
        aiRecommendations: aiAnalysis.aiRecommendations,
        aiSummary: aiAnalysis.aiSummary,
        confidence: aiAnalysis.confidence
      }
    };
  });

  // ÂÖ®‰Ωì„Çπ„ÉÜ„Éº„Çø„ÇπË®àÁÆó
  const criticalCount = parts.filter(p => p.status === 'critical').length;
  const warningCount = parts.filter(p => p.status === 'warning').length;
  
  let overallStatus = 'normal';
  if (criticalCount > 0) {
    overallStatus = 'critical';
  } else if (warningCount > 0) {
    overallStatus = 'warning';
  }

  // „É¨„Çπ„Éù„É≥„Çπ
  res.setHeader('Cache-Control', 'no-store');
  res.status(200).json({
    robotId: id,
    robotName: `Robot ${id}`,
    overallStatus,
    parts,
    lastCheck: containerTimestamp,
    containerTime: containerTime.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
    dockerTime: containerTime.toISOString(),
    statistics: {
      totalParts: parts.length,
      normal: parts.filter(p => p.status === 'normal').length,
      warning: warningCount,
      critical: criticalCount
    },
    // „Ç¢„É©„Éº„ÉàÊ©üÊßã„ÅÆÂèØË¶ñÂåñ
    alertMechanism: {
      active: true,
      frequency: '3 seconds',
      lastCheck: containerTimestamp,
      totalAlerts: global.alertHistory[id]?.length || 0,
      recentAlerts: global.alertHistory[id]?.slice(-5) || []
    },
    // Ê∏©Â∫¶Â±•Ê≠¥
    temperatureHistory: global.temperatureHistory[id]?.slice(-10) || [],
    // AI„Ç®„Éº„Ç∏„Çß„É≥„ÉàÁ∑èÂêàÂàÜÊûê
    aiAgentAnalysis: {
      agentName: aiAgent.name,
      agentVersion: aiAgent.version,
      capabilities: aiAgent.capabilities,
      overallRecommendations: aiAgent.generateMaintenanceRecommendations({ parts }),
      analysisTimestamp: containerTimestamp,
      totalPartsAnalyzed: parts.length,
      criticalPartsCount: criticalCount,
      warningPartsCount: warningCount
    }
  });
}
