<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京都ルート生成システム</title>
  <style>
    body{font-family: system-ui, -apple-system, "Yu Gothic UI", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif; padding:20px;}
    .container{max-width:1200px;margin:0 auto}
    .question{margin:12px 0}
    .routes{margin:16px 0}
    .markdown{border:1px solid #ddd;padding:16px;border-radius:6px;background:#fff}
    .controls{margin-top:12px}
    .node-nav{display:flex;gap:8px;margin-top:8px}
    .node-btn{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#f7f7f7;cursor:pointer}
    .node-btn.active{background:#007acc;color:#fff;border-color:#0066b3}
    .map-container{display:flex;gap:20px;margin-top:20px}
    .map-side{flex:1}
    .content-side{flex:1}
    #map{width:100%;height:400px;border:1px solid #ddd;border-radius:6px}
    .route-info{background:#f8f9fa;padding:12px;border-radius:6px;margin-top:12px}
    .route-step{margin:8px 0;padding:8px;background:#fff;border-left:3px solid #007acc;border-radius:3px}
    .loading{text-align:center;padding:20px;color:#666}
    .error{background:#ffe6e6;color:#d00;padding:12px;border-radius:6px;margin:12px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1>京都ルート生成システム</h1>
    <p>質問に回答して、あなたに最適な京都観光ルートを生成します。</p>

    <div class="controls">
      <button id="loadBtn">サンプルデータを読み込む</button>
      <button id="autoGenBtn">自動生成ルート</button>
    </div>

    <div id="questions"></div>
    <div class="routes" id="routes"></div>

    <div id="summary" class="markdown" style="display:none"></div>
    <div id="details" class="markdown" style="display:none"></div>

    <!-- Map and Route Display -->
    <div id="mapContainer" class="map-container" style="display:none">
      <div class="map-side">
        <h3>ルートマップ</h3>
        <div id="map"></div>
        <div id="routeInfo" class="route-info" style="display:none">
          <h4>ルート詳細</h4>
          <div id="routeSteps"></div>
        </div>
      </div>
      <div class="content-side">
        <h3>ルート情報</h3>
        <div id="mapSummary" class="markdown"></div>
      </div>
    </div>

    <p style="margin-top:18px;color:#666;font-size:0.9rem">操作: ノード間は左右矢印キーで移動できます。</p>
  </div>

  <!-- marked for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap"></script>

  <script>
    let data = null;
    let currentRoute = null;
    let currentNodeIndex = 0;
    let map = null;
    let directionsService = null;
    let directionsRenderer = null;
    let currentDirectionsResult = null;

    const el = id => document.getElementById(id);

    // Google Maps API初期化
    function initMap() {
      try {
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 35.0116, lng: 135.7681 }, // 京都の中心
          zoom: 12
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          draggable: true,
          map: map
        });
        console.log('Google Maps API initialized successfully');
      } catch (error) {
        console.error('Failed to initialize Google Maps API:', error);
        showError('Google Maps APIの初期化に失敗しました。APIキーを確認してください。');
      }
    }

    // Google Maps API読み込みエラーハンドリング
    window.gm_authFailure = function() {
      showError('Google Maps APIの認証に失敗しました。APIキーを確認してください。');
    };

    async function loadJsonFromUrl(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error('failed fetch');
      return res.json();
    }

    function renderQuestions(){
      const qroot = el('questions');
      qroot.innerHTML = '';
      data.userPreferences.questions.forEach(q =>{
        const div = document.createElement('div');
        div.className = 'question';
        const h = document.createElement('div'); h.textContent = q.text; div.appendChild(h);
        q.options.forEach(opt =>{
          const id = `opt-${q.id}-${opt.value}`;
          const label = document.createElement('label');
          label.style.marginRight='12px';
          const input = document.createElement('input');
          input.type='radio'; input.name=q.id; input.value=opt.value; input.id=id;
          label.appendChild(input);
          const span = document.createElement('span'); span.textContent=' '+opt.label;
          label.appendChild(span);
          div.appendChild(label);
        });
        qroot.appendChild(div);
      });

      const submit = document.createElement('button'); submit.textContent='ルートを表示';
      submit.onclick = matchRoutes;
      qroot.appendChild(submit);
    }

    function getAnswers(){
      const answers = {};
      data.userPreferences.questions.forEach(q=>{
        const v = document.querySelector(`input[name="${q.id}"]:checked`);
        answers[q.id] = v? v.value : null;
      });
      return answers;
    }

    function matchRoutes(){
      const answers = getAnswers();
      const routes = data.routes.filter(r => {
        return Object.keys(r.conditions).every(k => r.conditions[k] === answers[k]);
      });
      const root = el('routes'); root.innerHTML='';
      if(routes.length===0){ root.textContent='該当するルートが見つかりません。設定を変えてみてください。'; return; }
      routes.forEach(r=>{
        const card = document.createElement('div');
        const h = document.createElement('h3'); h.textContent = r.title; card.appendChild(h);
        const p = document.createElement('p'); p.textContent = r.description; card.appendChild(p);
        const btn = document.createElement('button'); btn.textContent='このルートを選択';
        btn.onclick = ()=> selectRoute(r);
        card.appendChild(btn);
        root.appendChild(card);
      });
    }

    function selectRoute(route){
      currentRoute = route;
      currentNodeIndex = 0;
      el('summary').style.display='block';
      el('summary').innerHTML = marked.parse(route.markdown_summary || (route.title + '\n\n' + route.description));
      renderNodeDetails();
      renderNodeButtons();
      
      // マップにルートを表示
      if (map && route.nodes && route.nodes.length > 0) {
        displayRouteOnMap(route);
      }
    }

    // ルートをマップに表示する関数
    async function displayRouteOnMap(route) {
      if (!map || !directionsService || !directionsRenderer) {
        console.error('Google Maps API not initialized');
        return;
      }

      try {
        // ルートの座標を取得
        const waypoints = route.nodes.map(nodeId => {
          const location = data.locations.find(loc => loc.id === nodeId);
          if (location && location.coordinates) {
            return {
              location: new google.maps.LatLng(location.coordinates.lat, location.coordinates.lng),
              stopover: true
            };
          }
          return null;
        }).filter(wp => wp !== null);

        if (waypoints.length < 2) {
          console.error('Not enough valid waypoints for route');
          return;
        }

        const request = {
          origin: waypoints[0].location,
          destination: waypoints[waypoints.length - 1].location,
          waypoints: waypoints.slice(1, -1),
          travelMode: google.maps.TravelMode.WALKING,
          optimizeWaypoints: true
        };

        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            currentDirectionsResult = result;
            directionsRenderer.setDirections(result);
            el('mapContainer').style.display = 'flex';
            displayRouteInfo(result);
            displayRouteSummary(route);
          } else {
            console.error('Directions request failed:', status);
            showError('ルートの生成に失敗しました: ' + status);
          }
        });
      } catch (error) {
        console.error('Error displaying route:', error);
        showError('ルートの表示中にエラーが発生しました: ' + error.message);
      }
    }

    // ルート情報を表示
    function displayRouteInfo(result) {
      const routeInfo = el('routeInfo');
      const routeSteps = el('routeSteps');
      
      routeInfo.style.display = 'block';
      routeSteps.innerHTML = '';

      const route = result.routes[0];
      const leg = route.legs[0];
      
      // 総距離と時間を表示
      const totalDistance = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
      const totalDuration = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0);
      
      const summaryDiv = document.createElement('div');
      summaryDiv.innerHTML = `
        <strong>総距離:</strong> ${(totalDistance / 1000).toFixed(1)}km<br>
        <strong>予想時間:</strong> ${Math.round(totalDuration / 60)}分
      `;
      routeSteps.appendChild(summaryDiv);

      // 各ステップを表示
      route.legs.forEach((leg, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'route-step';
        stepDiv.innerHTML = `
          <strong>ステップ ${index + 1}:</strong> ${leg.start_address} → ${leg.end_address}<br>
          <small>距離: ${leg.distance.text} | 時間: ${leg.duration.text}</small>
        `;
        routeSteps.appendChild(stepDiv);
      });
    }

    // ルートサマリーを表示
    function displayRouteSummary(route) {
      const mapSummary = el('mapSummary');
      mapSummary.innerHTML = marked.parse(route.markdown_summary || (route.title + '\n\n' + route.description));
    }

    // エラー表示
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      el('mapContainer').appendChild(errorDiv);
    }

    // auto-generate route based on simple scoring algorithm
    document.getElementById('autoGenBtn').addEventListener('click', ()=>{
      const answers = getAnswers();
      if(!answers.crowd_preference || !answers.goal){ alert('まず質問に回答してください'); return; }
      const generated = generateRoute(answers);
      // create a temporary route object
      const route = {
        id: 'generated_1',
        title: '【自動生成ルート】あなた向けのおすすめ',
        description: 'ユーザー設定に基づき自動生成されたルートです。',
        conditions: answers,
        nodes: generated.map(l=>l.id),
        markdown_summary: '### 自動生成ルート\n\nこのルートはあなたの設定に合わせて自動生成されました。\n'
      };
      // append image + short description into each location's markdown for better presentation
      generated.forEach(loc=>{
        const imageMd = loc.image? `![](${loc.image})\n\n` : '';
        route.markdown_summary += `\n---\n\n${imageMd}**${loc.name}** — ${loc.attributes.benefit || ''}\n\n`;
      });
      selectRoute(route);
      // also make these locations available in data.locations temporarily
      data.locations = Array.from(new Map([...generated.map(g=>[g.id,g]) , ...data.locations.map(l=>[l.id,l])]).values());
    });

    function generateRoute(answers){
      // simple heuristic scoring: match crowd preference and goal to attributes
      // score higher if crowd preference matches (e.g., if concerned prefer low/medium crowd)
      const pref = answers.crowd_preference;
      const goal = answers.goal;
      const scored = data.locations.map(loc=>{
        let score = 0;
        // crowd preference
        if(pref === 'concerned'){
          if(loc.attributes.crowd_level === 'medium') score += 2;
          if(loc.attributes.crowd_level === 'low') score += 3;
        } else {
          if(loc.attributes.crowd_level === 'high') score += 2;
        }
        // goal
        if(goal === 'want_energy'){
          if(loc.attributes.theme === 'gorgeous' || loc.attributes.theme === 'dynamic') score += 3;
        } else if(goal === 'want_calm'){
          if(loc.attributes.theme === 'wabi_sabi') score += 3;
        }
        // small tie-breaker: include benefit length
        score += (loc.attributes.benefit||'').length % 5;
        return { ...loc, score };
      });
      scored.sort((a,b)=> b.score - a.score);
      // choose top 2-3 depending on preference
      const count = (goal === 'want_energy') ? 3 : 2;
      return scored.slice(0,count).map(s=>({
        id:s.id,
        name:s.name,
        attributes:s.attributes,
        image:s.image,
        coordinates:s.coordinates
      }));
    }

    function renderNodeButtons(){
      const container = document.createElement('div');
      container.className='node-nav';
      currentRoute.nodes.forEach((nid, i)=>{
        const btn = document.createElement('button');
        btn.className='node-btn' + (i===currentNodeIndex? ' active': '');
        const loc = data.locations.find(l=> l.id===nid);
        btn.textContent = loc? loc.name : nid;
        btn.onclick = ()=>{ currentNodeIndex = i; renderNodeDetails(); updateNodeActive(); };
        container.appendChild(btn);
      });
      
      const routesEl = el('routes');
      // clear old node-nav
      const old = routesEl.querySelector('.node-nav'); if(old) old.remove();
      routesEl.appendChild(container);
    }

    function updateNodeActive(){
      const nodes = document.querySelectorAll('.node-btn');
      nodes.forEach((n,i)=>{ n.classList.toggle('active', i===currentNodeIndex); });
    }

    function renderNodeDetails(){
      const nid = currentRoute.nodes[currentNodeIndex];
      const loc = data.locations.find(l=> l.id===nid);
      el('details').style.display='block';
      el('details').innerHTML = loc? marked.parse(loc.markdown_details || (`# ${loc.name}\n`)) : '詳細が見つかりません';
    }

    // keyboard navigation
    document.addEventListener('keydown', e=>{
      if(!currentRoute) return;
      if(e.key === 'ArrowRight'){
        if(currentNodeIndex < currentRoute.nodes.length-1){ currentNodeIndex++; renderNodeDetails(); updateNodeActive(); }
      } else if(e.key === 'ArrowLeft'){
        if(currentNodeIndex > 0){ currentNodeIndex--; renderNodeDetails(); updateNodeActive(); }
      }
    });

    document.getElementById('loadBtn').addEventListener('click', loadSample);

    async function loadSample(){
      try{
        data = await loadJsonFromUrl('../frontend/routes.json');
        onDataLoaded();
      }catch(e){
        alert('routes.json の読み込みに失敗しました: '+e.message);
      }
    }

    function onDataLoaded(){
      renderQuestions();
      el('routes').innerHTML = '';
      el('summary').style.display='none';
      el('details').style.display='none';
    }

    // auto-load sample if opened via file:// may fail due to fetch CORS; user can click load
    (async ()=>{
      try{
        data = await loadJsonFromUrl('../frontend/routes.json');
        onDataLoaded();
      }catch(e){
        // ignore; wait for user action
      }
    })();
  </script>
</body>
</html>
